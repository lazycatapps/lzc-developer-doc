# 网络机制与 VPN

## 网络数据传输机制

### 直连模式

当终端设备所在网络环境具备 IPv6/NAT3 时， 懒猫微服将与用户设备建立直接数据传输连接。 此时客户端状态图标将显示为蓝色， 表示处于直连传输状态。 若终端设备所在网络环境不具备公网 IP 地址， 系统将根据 NAT 网络状况自动提供免费的网络穿透服务。

### 中继服务

在网络环境较为恶劣的情况下， 系统会自动切换至免费的中继数据传输服务。 由于采用端到端加密技术（TLS1.3/noise）， 数据传输内容对包括平台运营团队在内的任何第三方均不可见， 确保用户数据安全性。 中继传输状态下， 客户端状态图标将显示为黄色。

## 网络穿透服务范围

懒猫穿透服务属于系统网络层， 包括官方应用在内的所有应用都会自动支持， 范围包括：

- 平台应用商店上架的所有应用
- 开发者自主开发的应用程序
- 开发者搭建的虚拟机

该服务确保用户能够在全球范围内便捷访问微服云计算服务。

## VPN 共存解决方案 {#two_vpn}

微服客户端内测版本已经支持`全局模式(VPN Tun)`和`客户端模式(Proxy)`两种运行模式。
1. 全局模式： 对于非技术用户更友好， 终端中所有应用都可以访问微服资源
2. 客户端模式： 对于技术用户更加方便， 可以融洽的解决双 VPN 冲突

### 安卓平台后台常住

安卓平台下， 微服应用与微服客户端不在同一个 apk 内， 因此如果使用`客户端模式(Proxy)`， 需要将微服客户端常驻在后台, 不常驻会导致懒猫微服客户端被手机系统后台结束后引起不必要的网络错误。

安卓系统常住后台的方法， 以 Vivo 手机举例：
1. 从屏幕底部上滑， 切换到窗口切换界面
2. 点击懒猫微服客户端窗口顶部的小三角形， 在弹出的菜单中选择 `锁定` 菜单项， 即可将客户端常驻后台
3. 注意， 懒猫微服客户端和懒猫应用都需要锁定常驻哟， 比如懒猫相册，懒猫网盘等

此外， 安卓平台可通过 [Shelter](https://github.com/PeterCxy/Shelter) 方案， 通过双开工作区的原理来实现 VPN 双开。


### 第三方应用访问微服资源

如果您需要在客户端之外访问微服资源， 比如 VidHub 本地客户端， ssh 客户端之类。

使用`客户端模式`后， 这些第三方应用无法访问微服资源， 此时需要将`http://127.0.0.1:31085`这个微服客户端提供的本地代理添加到您的代理软件中， 并将`heiyu.space`域名流量转发到此。

此外如果您是 iOS 客户端， 则因为微服客户端无法后台常住(切换到后台 10s 内会被断网)， 所以也需要开启微服的后台常住(打开微服客户端->关于->查找设备)

(Android 版本目前未提供 http://127.0.0.1:31085， 如果需要请联系客户使用测试版)

## 减少对懒猫微服的网络影响{#vpn_config}

移动端使用`客户端模式(Proxy)`或在PC上运行了其他VPN软件后，会严重干扰懒猫微服客户端的工作， 需要您进一步进行以下配置， 以便将干扰减少到最低：

1. 将"*.heiyu.space"和"*.lazycat.cloud"在DNS上返回真实IP不要进行任何干扰。
2. 如果第三方VPN属于tun模式(ios/macos均为tun模式，android/linux/windows需要看具体软件)，则需要将`6.6.6.6/32`以及`2000::6666/128`这两个作为TUN旁路由规则中。(部分代理软件无此功能，这条主要影响打洞直连逻辑)
3. 将`fc03:1136:3800::/40`加入到直连规则中
4. (非必须)将heiyu.space的dns解析交由fc03:1136:3800::1来解析

配置1和2对应不同软件里的一些关键字:
- fake-ip-filter、always-real-ip。
   调整成功后在命令行下
   - `dig AAAA 微服名.heiyu.space`应该看到的是类似`fc03:1136:38bb:5ee2:44bb:7479:f44e:0`这种输出
   - `dig A hello.lazycat.cloud`看到的应该是`43.139.3.150`这种正常公网IP。如果是`198.x.x.x`就是还没配正确。
- tun.route-exclude-address、tun-excluded-routes。
  调整成功后在命令行下`ip route get 6.6.6.6`看到的应该是正常局域网出口，而非198.18.0.1之类的


::: tip 6.6.6.6

6.6.6.6以及2000::6666这两个IP并非官方服务器，也不会实际向这两个IP发起任何网络请求。

这两个IP仅仅是普通的公网IP，微服客户端会利用`UDP Dial 6.6.6.6`的形式去检测本地网络出口，以最低成本来判断当前是否有局域网。

在存在第三方代理软件时，此IP还可以作为桥梁，来让用户有针对性的进行规则配置，以便让微服客户端能正确获取局域网出口IP等，否则会导致所有打洞逻辑全部失效。

:::



## 客户端代理模式下优化方案{#optimize-proxy-mode}

### 保活方案

在非VPN模式下，操作系统可能会根据资源管理策略自动清理后台应用。为确保客户端稳定运行并避免因系统自动清理而被关闭，请按照以下优化方法进行设置。

优化教程：

[iOS保活图文教程](#iOS)   

[Android保活图文教程](#Android)

### 开了其他VPN软件，网络感觉变慢了，怎么办

客户端主页上的黄色小地球图标表示当前网络速度较慢。若想提升网络速度，可以参考以下民间图文教程，确保VPN规则放行懒猫微服，使网络畅通无阻。

优化教程：[PeppaPigConfigurationGuide](https://github.com/wlabby-1/PeppaPigConfigurationGuide)

#### iOS保活图文教程{#iOS}

<img src="https://lzc-playground-1301583638.cos.ap-chengdu.myqcloud.com/guidelines/395/20250414140712138.png?imageSlim" alt="image-20250414140711942" style="zoom:50%;" /> 

#### Android保活图文教程{#Android}

由于Android手机厂商繁多，以下未涉及到的手机厂商，烦请移驾到VIP群沟通

##### 小米手机:

允许使用后台流量

**小米 hyper os** 

1. 设置中搜索网络助手 ——> 打开助手后,点击联网管理 ——> 右上角点击后台联网权限  ——> 搜索懒猫微服 ——> 点击右边按钮允许（仅需开启懒猫微服）

![image-20250415145609296](https://lzc-playground-1301583638.cos.ap-chengdu.myqcloud.com/guidelines/395/20250415145609391.png?imageSlim)

**小米 Miui 系统**

2. 长按懒猫微服进入应用详情 ——> 点击月流量消耗  ——>  允许 后台运行时联网

![image-20250415150948805](https://lzc-playground-1301583638.cos.ap-chengdu.myqcloud.com/guidelines/395/20250415150948932.png?imageSlim)

##### 华为手机/荣耀手机

打开设置 ——> 应用和服务 ——> 应用启动管理  ——>  搜索懒猫微服后，点击右边的开关 ——> 点击右边按钮： 弹窗手动管理后， 选择下面的三个选项

![image-20250415151830868](https://lzc-playground-1301583638.cos.ap-chengdu.myqcloud.com/guidelines/395/20250415151830955.png?imageSlim)

**OPPO/真我手机** 

长按应用打开应用详情 ——> 打开耗电管理 ——> 允许应用后台行为
长按应用打开应用详情 ——> 打开应用流量 ——> 可在后台使用数据

![image-20250415152315761](https://lzc-playground-1301583638.cos.ap-chengdu.myqcloud.com/guidelines/395/20250415152315840.png?imageSlim)

**Other**

上面的都是大多数有2个设置， 1个是允许懒猫微服允许在后台运行，另外一个是允许后台使用流量联网权限。 

lzc-apk-shell的应用都依赖于懒猫微服客户端，这个时候客户端在后台,需要使用流量来连接微服，否则在相册，网盘无法连接到微服导致无法使用懒猫微服的应用。 
